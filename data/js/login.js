document.addEventListener('DOMContentLoaded', function () {
  // Hi·ªÉn th·ªã form ƒëƒÉng nh·∫≠p m·∫∑c ƒë·ªãnh khi trang load
  const loginFormContent = document.getElementById('loginFormContent');
  if (loginFormContent) {
    loginFormContent.style.display = 'block';
  }

  const registerForm = document.querySelector('#registerFormContent form');
  if (registerForm) {
    // Th√™m tr∆∞·ªùng x√°c nh·∫≠n m·∫≠t kh·∫©u n·∫øu ch∆∞a c√≥
    let confirmBox = registerForm.querySelector('.input-box.confirm-password');
    if (!confirmBox) {
      // ƒê·ªïi ch·ªâ s·ªë sang 3 v√¨ ƒë√£ th√™m tr∆∞·ªùng s·ªë ƒëi·ªán tho·∫°i
      const passwordBox = registerForm.querySelectorAll('.input-box')[3];
      confirmBox = document.createElement('div');
      confirmBox.className = 'input-box confirm-password';
      confirmBox.innerHTML = '<input type="password" placeholder="X√°c nh·∫≠n m·∫≠t kh·∫©u" required>';
      passwordBox.after(confirmBox);
    }

    // H√†m ki·ªÉm tra v√† b√°o ƒë·ªè realtime
    function validateInput(input, condition, message) {
      if (!condition) {
        input.style.borderColor = 'red';
        input.setCustomValidity(message);
      } else {
        input.style.borderColor = ''; // ƒê·ªÉ tr·ªëng ƒë·ªÉ tr·ªü v·ªÅ m√†u m·∫∑c ƒë·ªãnh (ƒëen)
        input.setCustomValidity('');
      }
    }

    const username = registerForm.querySelector('input[name="username"]');
    const email = registerForm.querySelector('input[name="email"]');
    const phone = registerForm.querySelector('input[name="phone"]');
    const password = registerForm.querySelector('input[name="password"]');
    const confirmPassword = registerForm.querySelector('.confirm-password input');

    username.addEventListener('input', function () {
      // Kh√¥ng b√°o ƒë·ªè khi tr·ªëng, ch·ªâ b√°o ƒë·ªè khi c√≥ n·ªôi dung nh∆∞ng kh√¥ng h·ª£p l·ªá (·ªü ƒë√¢y username ch·ªâ c·∫ßn kh√¥ng r·ªóng)
      if (username.value.trim() === '') {
        username.style.borderColor = 'white';
        username.setCustomValidity('');
      } else {
        validateInput(username, true, '');
      }
    });

    email.addEventListener('input', function () {
      if (email.value === '') {
        email.style.borderColor = 'white';
        email.setCustomValidity('');
      } else {
        validateInput(
          email,
          /^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/.test(email.value),
          'Email kh√¥ng h·ª£p l·ªá!'
        );
      }
    });

    phone.addEventListener('input', function () {
      if (phone.value === '') {
        phone.style.borderColor = 'white';
        phone.setCustomValidity('');
      } else {
        validateInput(
          phone,
          /^(0|\+84)[0-9]{9,10}$/.test(phone.value),
          'S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá!'
        );
      }
    });

    password.addEventListener('input', function () {
      if (password.value === '') {
        password.style.borderColor = 'white';
        password.setCustomValidity('');
        // ·∫®n b√°o ƒë·ªè cho x√°c nh·∫≠n m·∫≠t kh·∫©u n·∫øu tr∆∞·ªùng m·∫≠t kh·∫©u tr·ªëng
        confirmPassword.style.borderColor = 'white';
        confirmPassword.setCustomValidity('');
      } else {
        validateInput(
          password,
          password.value.length >= 6,
          'M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!'
        );
        // Ki·ªÉm tra l·∫°i x√°c nh·∫≠n m·∫≠t kh·∫©u n·∫øu ƒë√£ nh·∫≠p
        if (confirmPassword.value) {
          confirmPassword.dispatchEvent(new Event('input'));
        }
      }
    });

    confirmPassword.addEventListener('input', function () {
      if (confirmPassword.value === '' || password.value === '') {
        confirmPassword.style.borderColor = 'white';
        confirmPassword.setCustomValidity('');
      } else {
        validateInput(
          confirmPassword,
          password.value === confirmPassword.value,
          'M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!'
        );
      }
    });

    registerForm.addEventListener('submit', function (e) {
      // Ki·ªÉm tra c√°c input
      const username = registerForm.querySelector('input[name="username"]');
      const email = registerForm.querySelector('input[name="email"]');
      const phone = registerForm.querySelector('input[name="phone"]');
      const password = registerForm.querySelector('input[name="password"]');
      const confirmPassword = registerForm.querySelector('.confirm-password input');
      let valid = true;
      let message = '';

      // Reset border m√†u m·∫∑c ƒë·ªãnh
      [username, email, phone, password, confirmPassword].forEach(input => {
        input.style.borderColor = '';
      });

      if (!username.value.trim()) {
        valid = false;
        message = 'Vui l√≤ng nh·∫≠p t√™n ƒëƒÉng nh·∫≠p!';
        username.style.borderColor = 'red';
        username.focus();
      } else if (!email.value.match(/^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/)) {
        valid = false;
        message = 'Email kh√¥ng h·ª£p l·ªá!';
        email.style.borderColor = 'red';
        email.focus();
      } else if (!phone.value.match(/^(0|\+84)[0-9]{9,10}$/)) {
        valid = false;
        message = 'S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá!';
        phone.style.borderColor = 'red';
        phone.focus();
      } else if (password.value.length < 6) {
        valid = false;
        message = 'M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!';
        password.style.borderColor = 'red';
        password.focus();
      } else if (password.value !== confirmPassword.value) {
        valid = false;
        message = 'M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!';
        confirmPassword.style.borderColor = 'red';
        confirmPassword.focus();
      }

      if (!valid) {
        alert(message);
        e.preventDefault();
      }
    });

    // Th√™m n√∫t ·∫©n/hi·ªán m·∫≠t kh·∫©u cho c√°c tr∆∞·ªùng m·∫≠t kh·∫©u
    const passwordInputs = registerForm.querySelectorAll('input[type="password"]');
    passwordInputs.forEach(function(input) {
      // T·∫°o n√∫t toggle
      const toggle = document.createElement('span');
      toggle.textContent = 'üëÅÔ∏è';
      toggle.style.cursor = 'pointer';
      toggle.style.position = 'absolute';
      toggle.style.right = '20px';
      toggle.style.top = '50%';
      toggle.style.transform = 'translateY(-50%)';
      toggle.style.userSelect = 'none';

      // ƒê·∫∑t toggle v√†o .input-box
      const box = input.parentElement;
      box.style.position = 'relative';
      box.appendChild(toggle);

      toggle.addEventListener('click', function() {
        input.type = input.type === 'password' ? 'text' : 'password';
        toggle.textContent = input.type === 'password' ? 'üëÅÔ∏è' : 'üôà';
      });
    });
  }

  // Th√™m cho form ƒëƒÉng nh·∫≠p
  const loginForm = document.querySelector('#loginFormContent form');
  if (loginForm) {
    const passwordInput = loginForm.querySelector('input[type="password"]');
    if (passwordInput) {
      const toggle = document.createElement('span');
      toggle.textContent = 'üëÅÔ∏è';
      toggle.style.cursor = 'pointer';
      toggle.style.position = 'absolute';
      toggle.style.right = '20px';
      toggle.style.top = '50%';
      toggle.style.transform = 'translateY(-50%)';
      toggle.style.userSelect = 'none';

      const box = passwordInput.parentElement;
      box.style.position = 'relative';
      box.appendChild(toggle);

      toggle.addEventListener('click', function() {
        passwordInput.type = passwordInput.type === 'password' ? 'text' : 'password';
        toggle.textContent = passwordInput.type === 'password' ? 'üëÅÔ∏è' : 'üôà';
      });
    }
  }

  // X·ª≠ l√Ω chuy·ªÉn ƒë·ªïi gi·ªØa c√°c form
  function showForm(formId) {
    // ·∫®n t·∫•t c·∫£ form
    document.getElementById('loginFormContent').style.display = 'none';
    document.getElementById('registerFormContent').style.display = 'none';
    document.getElementById('forgotFormContent').style.display = 'none';
    
    // Hi·ªÉn th·ªã form ƒë∆∞·ª£c ch·ªçn
    document.getElementById(formId).style.display = 'block';
  }

  // Th√™m event listeners cho c√°c link chuy·ªÉn ƒë·ªïi form
  document.addEventListener('click', function(e) {
    if (e.target.getAttribute('for') === 'registerForm') {
      e.preventDefault();
      showForm('registerFormContent');
    } else if (e.target.getAttribute('for') === 'loginForm') {
      e.preventDefault();
      showForm('loginFormContent');
    } else if (e.target.getAttribute('for') === 'forgotForm') {
      e.preventDefault();
      showForm('forgotFormContent');
    }
  });
});